<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <title>Tag Bookmark</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <header class="bar">
      <h1>Tag Notes (Lite)</h1>
      <div style="display: flex; gap: 8px">
        <button type="button" id="theme-btn">🌓</button>
      </div>
    </header>

    <section class="controls">
      <form id="add-form" autocomplete="off">
        <input id="title" placeholder="제목" required />
        <input id="url" placeholder="링크(URL) 또는 메모" />
        <input id="tags" placeholder="태그(쉼표로 구분)" />
        <button type="submit">추가</button>
      </form>

      <div class="filters">
        <input id="q" placeholder="검색(제목/태그) — 300ms 디바운스" />
        <select id="sort">
          <option value="recent">정렬: 최신</option>
          <option value="title">정렬: 제목</option>
          <option value="tags">정렬: 태그수</option>
        </select>
        <button type="button" id="clear-filters">필터 초기화</button>
      </div>
    </section>

    <section class="grid" id="list"></section>
    <aside class="stats" id="stats"></aside>
    <div id="toast-root"></div>

    <script type="module">
      import { store } from './store.js';
      import { THEME } from './constants.js';
      import { themeBtnEl, qInputEl, sortEl } from './utils/dom.js';
      import { inputSearchFilter, inputSortFilter, clearFilter } from './utils/filter.js';
      import { createCardsRenderer } from './render/renderCards.js';
      import { addItem } from './actions/addItem.js';
      import { deleteItem } from './actions/deleteItem.js';

      (() => {
        const { filter } = store.get() ?? {};

        const savedQuery = filter.q ?? INITIAL_STATE.filter.q;
        if (qInputEl) qInputEl.value = savedQuery;

        const savedSort = filter.sort ?? INITIAL_STATE.filter.sort;
        if (sortEl) {
          sortEl.value = savedSort;

          const isValidOption = Array.from(sortEl.options).some((opt) => opt.value === savedSort);
          if (!isValidOption) {
            sortEl.value = INITIAL_STATE.filter.sort;
          }
        }
      })();

      // ================= 생성 및 구독 =================
      const render = createCardsRenderer();
      store.subscribe(render);
      store.subscribe((state) => document.body.classList.toggle(THEME.LIGHT, state.themeMode === THEME.LIGHT));

      // ================= 이벤트 =================
      themeBtnEl.addEventListener('click', () => {
        const isLight = document.body.classList.toggle(THEME.LIGHT);
        store.set((state) => ({ ...state, themeMode: isLight ? THEME.LIGHT : THEME.DARK }));
      });
      addItem();
      deleteItem();
      inputSearchFilter(); // 검색
      inputSortFilter(); // 정렬
      clearFilter();

      render(store.get());
    </script>
  </body>
</html>
